<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Master Boot Record</title><meta name=description content="A space where I put my notes, researches and stuffs."><link rel=stylesheet type=text/css href="http://fonts.googleapis.com/css?family=Ubuntu:regular,bold&subset=Latin"><link rel=stylesheet href=/css/style.css?1666551600><meta property="og:title" content="Thuc notes - Master Boot Record"><meta property="og:description" content="MBR, MBR partition, MBR sequence, compare with VBR"><meta property="og:image" content="https://thuc.space/images/master_boot_record/master_boot_record-format.png"><meta property="og:image:type" content="image/png"><meta property="og:type" content="website"></head><body><div class=header>Thuc notes &copy; 2022<div class=menu>| <a href=/>home</a>
| <a href=/series/>series</a>
| <a href=/tags/>tags</a>
| <a href=/about-me/>about me</a></div></div><h1>Master Boot Record</h1><div class=main><div class=article>Part of series <a class=series href=/series/osdev>osdev</a> |
<time>2021-07-23</time><div class=content><p>Master boot record</p><ul><li>First sector of a physical hard disk.</li><li>This sector is not a part of any partition (OS or data).</li><li>Contains two parts:<ul><li>MBR bootstrap program to locates the boot sector of other partitions.</li><li>Partition table contains a master list of all available partitions on all available disks.</li></ul></li><li>Master boot record is detected by boot signature (magic number).</li></ul><p>MBR Partition table</p><ul><li>Apply to a hard disk drive, use to manage partitions in disk</li><li>16 bytes, total&rsquo;s 64 bytes. Limited to 4 entries. To create more, use an extended partition.</li><li>Maximum size of a single MBR partition is 2TB.</li><li>Elements:<ul><li>Boot indicator: inactive - active/bootable partition</li><li>Bits to define Starting head, sector and Cylinder</li><li>System ID: define filesystem of the partition (ext2, fat32, NTFS, etc.)</li><li>Relative sector</li><li>Total sectors in the partition</li></ul></li></ul><p><img src=/images/master_boot_record/master_boot_record-format.png alt="Master Boot Record format"></p><p>Extended partitions</p><ul><li>A solution to add more than 4 partitions to the partition table.</li><li>Partition can have one and only one entry with SystemID = 0x5 or 0xF to define as an extended partition.</li><li>Extended partition is a physical partition that&rsquo;s subpartitioned into &ldquo;logical&rdquo; partitions.</li><li>partition table entry describing it has a StartLBA and NumSectors that describe the space inside which any number of logical partitions may sit.</li><li>At the start of an extended partition is an extended partition table. Format of extended partition table is same with MBR partition table.</li></ul><p>Master Boot Record sequence</p><ul><li>After BIOS finish their job, they load the first sector (512 bytes) of devices (Hardisk, disc, USB, etc.) to check boot signature.</li><li>The boot signature is called a magic number. If a device has a boot signature, it&rsquo;s can bootable.<ul><li>Boot signature is in a boot sector number 0.</li><li>Contains byte sequence: 0x55, 0xAA at byte offets 510 (0x1FE) and 511 (0x1FF).</li><li>0x1FE and 0x1FF is 2 last bytes of 512 bytes of the first sector.</li></ul></li><li>When BIOS recognize a boot device, master boot record is loaded into memory at 0x0000:0x7c00 (sector 0, address 0x7c00) from this device. It contains executable code.</li><li>Execution is transferred to the loaded boot record bootstrap program.</li></ul><p><img src=/images/master_boot_record/master_boot_record-magic_numbers.png alt="Master Boot Record format"></p><p>Master boot record bootstrap program:</p><ul><li>Currently, the DL register is set to &ldquo;drive number&rdquo; that MBR was loaded.</li><li>Master boot record process relocates itself away from 0x7c00: memory copy and far jump.</li><li>Determine which partition/device to boot OS.
If the user selects inactive partition, then set the partition chosen entry to active and clear active state from others.</li><li>Rewrite MBR if the partition table entries were modified.</li><li>Load Volume Boot Record (boot sector of bootloader) from selected partition.</li><li>Set DS:SI pointing to the selected partition table entry.</li><li>Jump to 0x7c00 (with CS set to 0, and DL set to the &ldquo;drive number&rdquo;).</li></ul><p>Volume boot record</p><ul><li>First sector of the first partition containing the OS.</li><li>Contains boot loader code and some file system info.</li></ul><p>Bootloader</p><ul><li>A program is in the boot sector (master boot record or Volume boot record).</li><li>Use to loads OS kernel.</li></ul></div><div class=tags>Tags: <a class=tag href=/tags/x86>x86</a> | <a class=tag href=/tags/mbr>mbr</a> | <a class=tag href=/tags/boot>boot</a> | <a class=tag href=/tags/kernel>kernel</a> |</div></div></div></body></html>