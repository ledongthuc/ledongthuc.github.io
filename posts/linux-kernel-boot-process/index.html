<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Linux kernel boot process</title><meta name=description content="A space where I put my notes, researches and stuffs."><link rel=stylesheet type=text/css href="http://fonts.googleapis.com/css?family=Ubuntu:regular,bold&subset=Latin"><link rel=stylesheet href=/css/style.css?1666551600><meta property="og:title" content="Thuc notes - Linux kernel boot process"><meta property="og:description" content="Linux&rsquo;s kernel boot process step by step"><meta property="og:image" content="/images/social.png"><meta property="og:image:type" content="image/png"><meta property="og:type" content="website"></head><body><div class=header>Thuc notes &copy; 2024<div class=menu>| <a href=/>home</a>
| <a href=/series/>series</a>
| <a href=/tags/>tags</a>
| <a href=/about-me/>about me</a></div></div><h1>Linux Kernel Boot Process</h1><div class=main><div class=article>Part of series <a class=series href=/series/osdev>osdev</a> |
<time>2021-06-01</time><div class=content><ul><li>BIOS loads Linux Kernel to memory and split to 2 parts:<ul><li>Real-mode kernel: Below 640K of memory</li><li>Proctected-mode kernel: Start from 1MB of memory</li></ul></li></ul><h2 id=real-mode-kernel>Real-mode kernel:</h2><ul><li><p><a href=http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/header.S#L110>http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/header.S#L110</a></p><ul><li>Real-mode kernel will be start by BIOS at <code>_start:</code></li><li>It will jump directly to <code>start_of_setup:</code></li></ul></li><li><p><a href=http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/header.S#L229>http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/header.S#L229</a></p><ul><li><code>_start</code> jumps to <code>start_of_setup:</code></li><li>Reset disk controller</li><li>Setup stack</li><li>Zero bss (<a href=https://en.wikipedia.org/wiki/.bss>https://en.wikipedia.org/wiki/.bss</a>)</li><li>Call to a C <code>main()</code></li></ul></li><li><p><a href=http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/main.c#L122>http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/main.c#L122</a></p><ul><li><code>start_of_setup:</code> calls <code>main()</code></li><li>Prepare/copy boot parameters</li><li>Initilize memory heap</li><li>Detect memory layout</li><li>Query MCA</li><li>Set video mode</li><li>Invoke method <code>go_to_protected_mode()</code></li></ul></li><li><p><a href=http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/pm.c#L153>http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/pm.c#L153</a></p><ul><li><code>main()</code> calls <code>go_to_protected_mode()</code></li><li>The method purpose is used to prepare steps before switch to protected mode</li><li>Switch hook</li><li>Move compressed kernel to correct place</li><li>Resejt co-processors</li><li>Setup IDT <a href=https://en.wikipedia.org/wiki/Interrupt_descriptor_table>https://en.wikipedia.org/wiki/Interrupt_descriptor_table</a></li><li>Setup GDT <a href=https://en.wikipedia.org/wiki/Global_Descriptor_Table>https://en.wikipedia.org/wiki/Global_Descriptor_Table</a></li><li>Jump to <code>protected_mode_jump:</code></li></ul></li></ul><h2 id=protected-mode>Protected-mode:</h2><ul><li><p><a href=http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/pmjump.S#L31>http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/pmjump.S#L31</a></p><ul><li><code>go_to_protected_mode()</code> calls <code>protected_mode_jump:</code></li><li>Prepare/copy boot parameters</li><li>Enable protected mode</li><li>Disable paging <a href=https://en.wikipedia.org/wiki/Memory_paging>https://en.wikipedia.org/wiki/Memory_paging</a></li><li>Jump to <code>startup_32:</code></li></ul></li><li><p><a href=http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/compressed/head_32.S#L35>http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/compressed/head_32.S#L35</a></p><ul><li><code>protected_mode_jump:</code> jumps to <code>startup_32:</code></li><li>Doing some stuffs</li><li>Call to <code>decompress_kernel()</code></li><li>Clears the bss segment</li><li>Setup final GDT <a href=https://en.wikipedia.org/wiki/Global_Descriptor_Table>https://en.wikipedia.org/wiki/Global_Descriptor_Table</a></li><li>Enables paging <a href=https://en.wikipedia.org/wiki/Memory_paging>https://en.wikipedia.org/wiki/Memory_paging</a></li><li>Initializes a stack</li><li>Setup final IDT <a href=https://en.wikipedia.org/wiki/Interrupt_descriptor_table>https://en.wikipedia.org/wiki/Interrupt_descriptor_table</a></li><li>Call to <code>start_kernel()</code></li></ul></li><li><p><a href=http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/compressed/misc.c#L368>http://lxr.linux.no/#linux+v2.6.25.6/arch/x86/boot/compressed/misc.c#L368</a></p><ul><li><code>startup_32:</code> calls to <code>decompress_kernel()</code></li><li>Uncompressed kernel will replace at place of existed compressed kernel. Start at 1MB</li></ul></li><li><p><a href=http://lxr.linux.no/#linux+v2.6.25.6/init/main.c#L507>http://lxr.linux.no/#linux+v2.6.25.6/init/main.c#L507</a></p><ul><li><code>startup_32:</code> calls to <code>start_kernel()</code></li><li>Set PID = 0</li><li>Initialize stuffs, such as: scheduler, memory zones, time keeping, cpu, cgroup</li><li>Call to <code>rest_init()</code></li></ul></li><li><p><a href=http://lxr.linux.no/#linux+v2.6.25.6/init/main.c#L432>http://lxr.linux.no/#linux+v2.6.25.6/init/main.c#L432</a></p><ul><li><code>start_kernel()</code> calls to <code>rest_init()</code></li><li>Create another thread to call <code>kernel_init()</code></li><li>Create scheduling</li><li>Sleep by call <code>cpu_idle()</code></li></ul></li><li><p><a href=http://lxr.linux.no/linux+v2.6.25.6/init/main.c#L808>http://lxr.linux.no/linux+v2.6.25.6/init/main.c#L808</a></p><ul><li><code>start_kernel()</code> create thread and call to <code>kernel_init()</code></li><li>Set PID = 1</li><li>Init the remaining CPUs</li><li>Init work queue</li><li>Init user mode</li><li>Init driver</li><li>Call to <code>init_post()</code></li></ul></li><li><p><a href=http://lxr.linux.no/#linux+v2.6.25.6/init/main.c#L769>http://lxr.linux.no/#linux+v2.6.25.6/init/main.c#L769</a></p><ul><li><code>kernel_init()</code> calls to <code>init_post()</code></li><li>Execute /sbin/init, /etc/init, /bin/init, and /bin/sh in order</li></ul></li></ul></div><div class=tags>Tags: <a class=tag href=/tags/linux>linux</a> | <a class=tag href=/tags/boot>boot</a> | <a class=tag href=/tags/kernel>kernel</a> |</div></div></div></body></html>